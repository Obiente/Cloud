global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: "obiente-cloud"

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets: []

# Load rules once and periodically evaluate them
rule_files:
  # - "alert_rules.yml"

scrape_configs:
  # Prometheus itself
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]  # Self-scraping via localhost (container's own port)

  # Traefik metrics
  - job_name: "traefik"
    dns_sd_configs:
      - names:
          - "tasks.traefik"
        type: "A"
        port: 8080
    metrics_path: /metrics

  # Docker Swarm nodes
  - job_name: "docker-swarm-nodes"
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: nodes
    relabel_configs:
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: instance
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: node_name
      - source_labels: [__meta_dockerswarm_node_id]
        target_label: node_id

  # Docker Swarm services
  - job_name: "docker-swarm-services"
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: services
    relabel_configs:
      - source_labels: [__meta_dockerswarm_service_name]
        target_label: service
      - source_labels: [__meta_dockerswarm_service_label_com_obiente_service]
        target_label: obiente_service

  # API instances - Prometheus metrics endpoint
  # Using dockerswarm_sd_configs to get node hostnames instead of IPs
  - job_name: "api"
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: tasks
        filters:
          - name: label
            values: ["com.docker.swarm.service.name=api"]
    metrics_path: /metrics
    scrape_interval: 15s
    relabel_configs:
      # Use node hostname as instance label to show node names instead of IPs
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: instance
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: node_name
      # Keep service name for reference
      - source_labels: [__meta_dockerswarm_service_name]
        target_label: service
      # Only scrape tasks that are running
      - source_labels: [__meta_dockerswarm_task_desired_state]
        regex: running
        action: keep

  # Former Node API removed

  # PostgreSQL (via pg_exporter would be added here)
  - job_name: "postgresql"
    static_configs:
      - targets: [] # Add pg_exporter endpoints

  # Redis (via redis_exporter would be added here)
  - job_name: "redis"
    static_configs:
      - targets: [] # Add redis_exporter endpoints

  # VPS Gateway - DHCP and SSH proxy metrics
  - job_name: "vps-gateway"
    dockerswarm_sd_configs:
      - host: unix:///var/run/docker.sock
        role: tasks
        filters:
          - name: label
            values: ["com.docker.swarm.service.name=vps-gateway"]
    metrics_path: /metrics
    scrape_interval: 15s
    relabel_configs:
      # Use node hostname as instance label
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: instance
      - source_labels: [__meta_dockerswarm_node_hostname]
        target_label: node_name
      # Keep service name for reference
      - source_labels: [__meta_dockerswarm_service_name]
        target_label: service
      # Only scrape tasks that are running
      - source_labels: [__meta_dockerswarm_task_desired_state]
        regex: running
        action: keep
      # Set the metrics port to 9091 (default metrics port for vps-gateway)
      # Docker Swarm service discovery provides IP:port, we need to replace the port
      - source_labels: [__address__]
        regex: "(.+):\\d+"
        target_label: __address__
        replacement: "${1}:9091"

  # etcd cluster
  - job_name: "etcd"
    dns_sd_configs:
      - names:
          - "tasks.etcd"
        type: "A"
        port: 2379
    metrics_path: /metrics
