syntax = "proto3";

package obiente.cloud.superadmin.v1;

option go_package = "api/gen/proto/obiente/cloud/superadmin/v1;superadminv1";

import "google/protobuf/timestamp.proto";
import "obiente/cloud/deployments/v1/deployment_service.proto";

service SuperadminService {
  // Returns a system-wide overview for superadmin operators.
  rpc GetOverview(GetOverviewRequest) returns (GetOverviewResponse);
  
  // DNS management endpoints
  rpc QueryDNS(QueryDNSRequest) returns (QueryDNSResponse);
  rpc ListDNSRecords(ListDNSRecordsRequest) returns (ListDNSRecordsResponse);
  rpc GetDNSConfig(GetDNSConfigRequest) returns (GetDNSConfigResponse);
  
  // DNS Delegation API Key management
  rpc CreateDNSDelegationAPIKey(CreateDNSDelegationAPIKeyRequest) returns (CreateDNSDelegationAPIKeyResponse);
  rpc ListDNSDelegationAPIKeys(ListDNSDelegationAPIKeysRequest) returns (ListDNSDelegationAPIKeysResponse);
  rpc RevokeDNSDelegationAPIKey(RevokeDNSDelegationAPIKeyRequest) returns (RevokeDNSDelegationAPIKeyResponse);
  rpc RevokeDNSDelegationAPIKeyForOrganization(RevokeDNSDelegationAPIKeyForOrganizationRequest) returns (RevokeDNSDelegationAPIKeyForOrganizationResponse);
  // Public pricing endpoint - no authentication required
  rpc GetPricing(GetPricingRequest) returns (GetPricingResponse);
  
  // Abuse detection endpoints
  rpc GetAbuseDetection(GetAbuseDetectionRequest) returns (GetAbuseDetectionResponse);
  
  // Income and billing overview endpoints
  rpc GetIncomeOverview(GetIncomeOverviewRequest) returns (GetIncomeOverviewResponse);
}

message GetOverviewRequest {}

message GetOverviewResponse {
  OverviewCounts counts = 1;
  repeated OrganizationOverview organizations = 2;
  repeated PendingInvite pending_invites = 3;
  repeated DeploymentOverview deployments = 4;
  repeated OrganizationUsage usages = 5;
}

message OverviewCounts {
  int64 total_organizations = 1;
  int64 active_members = 2;
  int64 pending_invites = 3;
  int64 total_deployments = 4;
}

message OrganizationOverview {
  string id = 1;
  string name = 2;
  string slug = 3;
  optional string domain = 4;
  string plan = 5;
  string status = 6;
  google.protobuf.Timestamp created_at = 7;
  int64 member_count = 8;
  int64 invite_count = 9;
  int64 deployment_count = 10;
}

message PendingInvite {
  string id = 1;
  string organization_id = 2;
  string email = 3;
  string role = 4;
  google.protobuf.Timestamp invited_at = 5;
}

message DeploymentOverview {
  string id = 1;
  string organization_id = 2;
  string name = 3;
  obiente.cloud.deployments.v1.Environment environment = 4;
  obiente.cloud.deployments.v1.DeploymentStatus status = 5;
  optional string domain = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp last_deployed_at = 8;
}

message OrganizationUsage {
  string organization_id = 1;
  string organization_name = 2;
  string month = 3;
  int64 cpu_core_seconds = 4;
  int64 memory_byte_seconds = 5;
  int64 bandwidth_rx_bytes = 6;
  int64 bandwidth_tx_bytes = 7;
  int64 storage_bytes = 8;
  int32 deployments_active_peak = 9;
}

// DNS Query Request
message QueryDNSRequest {
  string domain = 1; // Domain to query (e.g., deploy-123.my.obiente.cloud)
  string record_type = 2; // DNS record type (A, AAAA, TXT, etc.) - defaults to A
}

// DNS Query Response
message QueryDNSResponse {
  string domain = 1;
  string record_type = 2;
  repeated string records = 3; // IP addresses or record values
  string error = 4; // Error message if query failed
  int64 ttl = 5; // Time to live in seconds
}

// List DNS Records Request
message ListDNSRecordsRequest {
  optional string deployment_id = 1; // Filter by deployment ID
  optional string organization_id = 2; // Filter by organization ID
  optional string record_type = 3; // Filter by record type (A, SRV) - empty means all
}

// DNS Record Information
message DNSRecord {
  string record_type = 1; // A or SRV
  string deployment_id = 2; // Deployment ID (for A records)
  string game_server_id = 3; // Game Server ID (for SRV records)
  string organization_id = 4;
  string deployment_name = 5; // Deployment name (for A records)
  string game_server_name = 6; // Game server name (for SRV records)
  string domain = 7; // Full domain (e.g., deploy-123.my.obiente.cloud or _minecraft._tcp.gameserver-123.my.obiente.cloud)
  repeated string ip_addresses = 8; // Resolved IP addresses (for A records)
  string target = 9; // SRV target hostname/IP (for SRV records)
  int32 port = 10; // Port (for SRV records)
  string region = 11; // Region where resource is running
  string status = 12; // Resource status
  google.protobuf.Timestamp last_resolved = 13;
}

// List DNS Records Response
message ListDNSRecordsResponse {
  repeated DNSRecord records = 1;
}

// Get DNS Config Request
message GetDNSConfigRequest {}

// DNS Configuration
message DNSConfig {
  repeated string traefik_ips = 1; // All configured Traefik IPs
  map<string, TraefikIPs> traefik_ips_by_region = 2; // Traefik IPs grouped by region
  repeated string dns_server_ips = 3; // DNS server IPs
  string dns_port = 4; // DNS server port
  int64 cache_ttl_seconds = 5; // Cache TTL in seconds
}

message TraefikIPs {
  string region = 1;
  repeated string ips = 2;
}

// Get DNS Config Response
message GetDNSConfigResponse {
  DNSConfig config = 1;
}

// Get Pricing Request - public endpoint
message GetPricingRequest {}

// Get Pricing Response
message GetPricingResponse {
  double cpu_cost_per_core_second = 1;
  double memory_cost_per_byte_second = 2;
  double bandwidth_cost_per_byte = 3;
  double storage_cost_per_byte_month = 4;
  string pricing_info = 5; // Human-readable description
}

// DNS Delegation API Key Management

// Create DNS Delegation API Key Request
message CreateDNSDelegationAPIKeyRequest {
  string description = 1; // Description of who/what this key is for
  optional string source_api = 2; // URL of the API that will use this key (optional)
  optional string organization_id = 3; // Organization ID (optional, required for non-superadmins, inferred from user's memberships if not provided)
}

// Create DNS Delegation API Key Response
message CreateDNSDelegationAPIKeyResponse {
  string api_key = 1; // The generated API key (shown only once)
  string message = 2; // Success message
  string description = 3; // Description of the API key
}

// Revoke DNS Delegation API Key Request
message RevokeDNSDelegationAPIKeyRequest {
  string api_key = 1; // The API key to revoke
}

// Revoke DNS Delegation API Key Response
message RevokeDNSDelegationAPIKeyResponse {
  bool success = 1;
  string message = 2; // Success message
}

// Revoke DNS Delegation API Key For Organization Request
message RevokeDNSDelegationAPIKeyForOrganizationRequest {
  string organization_id = 1; // Organization ID whose API key to revoke
}

// Revoke DNS Delegation API Key For Organization Response
message RevokeDNSDelegationAPIKeyForOrganizationResponse {
  bool success = 1;
  string message = 2; // Success message
}

// List DNS Delegation API Keys Request
message ListDNSDelegationAPIKeysRequest {
  optional string organization_id = 1; // Filter by organization ID (optional)
}

// DNS Delegation API Key Info
message DNSDelegationAPIKeyInfo {
  string id = 1; // API key ID
  string description = 2; // Description
  string source_api = 3; // Source API URL (if set)
  string organization_id = 4; // Organization ID (if set)
  bool is_active = 5; // Whether the key is active
  google.protobuf.Timestamp created_at = 6; // When the key was created
  google.protobuf.Timestamp revoked_at = 7; // When the key was revoked (if revoked)
  string stripe_subscription_id = 8; // Stripe subscription ID (if linked to subscription)
}

// List DNS Delegation API Keys Response
message ListDNSDelegationAPIKeysResponse {
  repeated DNSDelegationAPIKeyInfo api_keys = 1;
}

// Abuse Detection

// Get Abuse Detection Request
message GetAbuseDetectionRequest {}

// Abuse Detection Response
message GetAbuseDetectionResponse {
  repeated SuspiciousOrganization suspicious_organizations = 1;
  repeated SuspiciousActivity suspicious_activities = 2;
  AbuseMetrics metrics = 3;
}

// Suspicious Organization
message SuspiciousOrganization {
  string organization_id = 1;
  string organization_name = 2;
  string reason = 3; // Why it's flagged
  int64 risk_score = 4; // 0-100, higher is more suspicious
  int64 created_count_24h = 5; // Resources created in last 24h
  int64 failed_deployments_24h = 6; // Failed deployments in last 24h
  int64 total_credits_spent = 7; // Total credits spent
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp last_activity = 9;
}

// Suspicious Activity
message SuspiciousActivity {
  string id = 1;
  string organization_id = 2;
  string activity_type = 3; // "rapid_creation", "failed_payments", "unusual_usage", etc.
  string description = 4;
  int64 severity = 5; // 0-100
  google.protobuf.Timestamp occurred_at = 6;
}

// Abuse Metrics
message AbuseMetrics {
  int64 total_suspicious_orgs = 1;
  int64 high_risk_orgs = 2; // Risk score > 70
  int64 rapid_creations_24h = 3; // Organizations with >10 resources created in 24h
  int64 failed_payment_attempts_24h = 4;
  int64 unusual_usage_spikes_24h = 5;
}

// Income Overview

// Get Income Overview Request
message GetIncomeOverviewRequest {
  optional string start_date = 1; // ISO 8601 date string (optional, defaults to 30 days ago)
  optional string end_date = 2; // ISO 8601 date string (optional, defaults to now)
}

// Income Overview Response
message GetIncomeOverviewResponse {
  IncomeSummary summary = 1;
  repeated MonthlyIncome monthly_income = 2;
  repeated TopCustomer top_customers = 3;
  repeated BillingTransaction transactions = 4;
  PaymentMetrics payment_metrics = 5;
}

// Income Summary
message IncomeSummary {
  double total_revenue = 1; // Total revenue in period
  double monthly_recurring_revenue = 2; // Estimated MRR
  double average_monthly_revenue = 3; // Average monthly revenue
  int64 total_transactions = 4;
  double total_refunds = 5;
  double net_revenue = 6; // Revenue minus refunds
  double estimated_monthly_income = 7; // Estimated monthly income from all orgs based on usage
}

// Monthly Income
message MonthlyIncome {
  string month = 1; // YYYY-MM format
  double revenue = 2;
  int64 transaction_count = 3;
  double refunds = 4;
}

// Top Customer
message TopCustomer {
  string organization_id = 1;
  string organization_name = 2;
  double total_revenue = 3;
  int64 transaction_count = 4;
  google.protobuf.Timestamp first_payment = 5;
  google.protobuf.Timestamp last_payment = 6;
}

// Billing Transaction
message BillingTransaction {
  string id = 1;
  string organization_id = 2;
  string organization_name = 3;
  string type = 4; // "payment", "refund", "credit_add", "credit_remove"
  double amount_cents = 5;
  string currency = 6;
  string status = 7; // "succeeded", "failed", "pending"
  optional string stripe_invoice_id = 8;
  optional string stripe_payment_intent_id = 9;
  optional string note = 10;
  google.protobuf.Timestamp created_at = 11;
}

// Payment Metrics
message PaymentMetrics {
  double success_rate = 1; // Percentage of successful payments
  int64 successful_payments = 2;
  int64 failed_payments = 3;
  int64 pending_payments = 4;
  double average_payment_amount = 5;
  double largest_payment = 6;
}