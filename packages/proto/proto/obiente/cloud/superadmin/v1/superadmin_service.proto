syntax = "proto3";

package obiente.cloud.superadmin.v1;

option go_package = "api/gen/proto/obiente/cloud/superadmin/v1;superadminv1";

import "google/protobuf/timestamp.proto";
import "obiente/cloud/deployments/v1/deployment_service.proto";
import "obiente/cloud/billing/v1/billing_service.proto";

service SuperadminService {
  // Returns a system-wide overview for superadmin operators.
  rpc GetOverview(GetOverviewRequest) returns (GetOverviewResponse);
  
  // DNS management endpoints
  rpc QueryDNS(QueryDNSRequest) returns (QueryDNSResponse);
  rpc ListDNSRecords(ListDNSRecordsRequest) returns (ListDNSRecordsResponse);
  rpc GetDNSConfig(GetDNSConfigRequest) returns (GetDNSConfigResponse);
  rpc ListDelegatedDNSRecords(ListDelegatedDNSRecordsRequest) returns (ListDelegatedDNSRecordsResponse);
  rpc HasDelegatedDNS(HasDelegatedDNSRequest) returns (HasDelegatedDNSResponse);
  
  // DNS Delegation API Key management
  rpc CreateDNSDelegationAPIKey(CreateDNSDelegationAPIKeyRequest) returns (CreateDNSDelegationAPIKeyResponse);
  rpc ListDNSDelegationAPIKeys(ListDNSDelegationAPIKeysRequest) returns (ListDNSDelegationAPIKeysResponse);
  rpc RevokeDNSDelegationAPIKey(RevokeDNSDelegationAPIKeyRequest) returns (RevokeDNSDelegationAPIKeyResponse);
  rpc RevokeDNSDelegationAPIKeyForOrganization(RevokeDNSDelegationAPIKeyForOrganizationRequest) returns (RevokeDNSDelegationAPIKeyForOrganizationResponse);
  // Public pricing endpoint - no authentication required
  rpc GetPricing(GetPricingRequest) returns (GetPricingResponse);
  
  // Abuse detection endpoints
  rpc GetAbuseDetection(GetAbuseDetectionRequest) returns (GetAbuseDetectionResponse);
  
  // Income and billing overview endpoints
  rpc GetIncomeOverview(GetIncomeOverviewRequest) returns (GetIncomeOverviewResponse);
  
  // Invoice management endpoints
  rpc ListAllInvoices(ListAllInvoicesRequest) returns (ListAllInvoicesResponse);
  rpc SendInvoiceReminder(SendInvoiceReminderRequest) returns (SendInvoiceReminderResponse);
  
  // Plan management endpoints
  rpc ListPlans(ListPlansRequest) returns (ListPlansResponse);
  rpc CreatePlan(CreatePlanRequest) returns (CreatePlanResponse);
  rpc UpdatePlan(UpdatePlanRequest) returns (UpdatePlanResponse);
  rpc DeletePlan(DeletePlanRequest) returns (DeletePlanResponse);
  rpc AssignPlanToOrganization(AssignPlanToOrganizationRequest) returns (AssignPlanToOrganizationResponse);
  
  // User management endpoints
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
}

message GetOverviewRequest {}

message GetOverviewResponse {
  OverviewCounts counts = 1;
  repeated OrganizationOverview organizations = 2;
  repeated SuperadminPendingInvite pending_invites = 3;
  repeated DeploymentOverview deployments = 4;
  repeated OrganizationUsage usages = 5;
}

message OverviewCounts {
  int64 total_organizations = 1;
  int64 active_members = 2;
  int64 pending_invites = 3;
  int64 total_deployments = 4;
}

message OrganizationOverview {
  string id = 1;
  string name = 2;
  string slug = 3;
  optional string domain = 4;
  string plan = 5;
  string status = 6;
  google.protobuf.Timestamp created_at = 7;
  int64 member_count = 8;
  int64 invite_count = 9;
  int64 deployment_count = 10;
}

message SuperadminPendingInvite {
  string id = 1;
  string organization_id = 2;
  string email = 3;
  string role = 4;
  google.protobuf.Timestamp invited_at = 5;
}

message DeploymentOverview {
  string id = 1;
  string organization_id = 2;
  string name = 3;
  obiente.cloud.deployments.v1.Environment environment = 4;
  obiente.cloud.deployments.v1.DeploymentStatus status = 5;
  optional string domain = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp last_deployed_at = 8;
}

message OrganizationUsage {
  string organization_id = 1;
  string organization_name = 2;
  string month = 3;
  int64 cpu_core_seconds = 4;
  int64 memory_byte_seconds = 5;
  int64 bandwidth_rx_bytes = 6;
  int64 bandwidth_tx_bytes = 7;
  int64 storage_bytes = 8;
  int32 deployments_active_peak = 9;
}

// DNS Query Request
message QueryDNSRequest {
  string domain = 1; // Domain to query (e.g., deploy-123.my.obiente.cloud)
  string record_type = 2; // DNS record type (A, AAAA, TXT, etc.) - defaults to A
}

// DNS Query Response
message QueryDNSResponse {
  string domain = 1;
  string record_type = 2;
  repeated string records = 3; // IP addresses or record values
  string error = 4; // Error message if query failed
  int64 ttl = 5; // Time to live in seconds
}

// List DNS Records Request
message ListDNSRecordsRequest {
  optional string deployment_id = 1; // Filter by deployment ID
  optional string organization_id = 2; // Filter by organization ID
  optional string record_type = 3; // Filter by record type (A, SRV) - empty means all
}

// DNS Record Information
message DNSRecord {
  string record_type = 1; // A or SRV
  string deployment_id = 2; // Deployment ID (for A records)
  string game_server_id = 3; // Game Server ID (for SRV records)
  string organization_id = 4;
  string deployment_name = 5; // Deployment name (for A records)
  string game_server_name = 6; // Game server name (for SRV records)
  string domain = 7; // Full domain (e.g., deploy-123.my.obiente.cloud or _minecraft._tcp.gameserver-123.my.obiente.cloud)
  repeated string ip_addresses = 8; // Resolved IP addresses (for A records)
  string target = 9; // SRV target hostname/IP (for SRV records)
  int32 port = 10; // Port (for SRV records)
  string region = 11; // Region where resource is running
  string status = 12; // Resource status
  google.protobuf.Timestamp last_resolved = 13;
}

// List DNS Records Response
message ListDNSRecordsResponse {
  repeated DNSRecord records = 1;
}

// Get DNS Config Request
message GetDNSConfigRequest {}

// DNS Configuration
message DNSConfig {
  repeated string traefik_ips = 1; // All configured Traefik IPs
  map<string, TraefikIPs> traefik_ips_by_region = 2; // Traefik IPs grouped by region
  repeated string dns_server_ips = 3; // DNS server IPs
  string dns_port = 4; // DNS server port
  int64 cache_ttl_seconds = 5; // Cache TTL in seconds
}

message TraefikIPs {
  string region = 1;
  repeated string ips = 2;
}

// Get DNS Config Response
message GetDNSConfigResponse {
  DNSConfig config = 1;
}

// List Delegated DNS Records Request
message ListDelegatedDNSRecordsRequest {
  optional string organization_id = 1; // Filter by organization ID
  optional string api_key_id = 2; // Filter by API key ID
  optional string record_type = 3; // Filter by record type (A, SRV) - empty means all
}

// Delegated DNS Record Information
message DelegatedDNSRecord {
  string id = 1;
  string domain = 2; // Full domain (e.g., deploy-123.my.obiente.cloud)
  string record_type = 3; // A or SRV
  repeated string records = 4; // Record values (IP addresses for A, SRV strings for SRV)
  string source_api = 5; // URL of the API that pushed this record
  string api_key_id = 6; // ID of the API key that delegated this record
  string organization_id = 7; // Organization that owns the API key
  int64 ttl = 8; // TTL in seconds
  google.protobuf.Timestamp expires_at = 9; // When this record expires
  google.protobuf.Timestamp last_updated = 10; // Last time this record was updated
  google.protobuf.Timestamp created_at = 11;
}

// List Delegated DNS Records Response
message ListDelegatedDNSRecordsResponse {
  repeated DelegatedDNSRecord records = 1;
}

// Has Delegated DNS Request
message HasDelegatedDNSRequest {}

// Has Delegated DNS Response
message HasDelegatedDNSResponse {
  bool has_delegated_dns = 1; // Whether the user has delegated DNS
  string organization_id = 2; // Organization ID that has delegated DNS (if any)
  string api_key_id = 3; // API key ID (if any)
}

// Get Pricing Request - public endpoint
message GetPricingRequest {}

// Get Pricing Response
message GetPricingResponse {
  double cpu_cost_per_core_second = 1;
  double memory_cost_per_byte_second = 2;
  double bandwidth_cost_per_byte = 3;
  double storage_cost_per_byte_month = 4;
  string pricing_info = 5; // Human-readable description
}

// DNS Delegation API Key Management

// Create DNS Delegation API Key Request
message CreateDNSDelegationAPIKeyRequest {
  string description = 1; // Description of who/what this key is for
  optional string source_api = 2; // URL of the API that will use this key (optional)
  optional string organization_id = 3; // Organization ID (optional, required for non-superadmins, inferred from user's memberships if not provided)
}

// Create DNS Delegation API Key Response
message CreateDNSDelegationAPIKeyResponse {
  string api_key = 1; // The generated API key (shown only once)
  string message = 2; // Success message
  string description = 3; // Description of the API key
}

// Revoke DNS Delegation API Key Request
message RevokeDNSDelegationAPIKeyRequest {
  string api_key = 1; // The API key to revoke
}

// Revoke DNS Delegation API Key Response
message RevokeDNSDelegationAPIKeyResponse {
  bool success = 1;
  string message = 2; // Success message
}

// Revoke DNS Delegation API Key For Organization Request
message RevokeDNSDelegationAPIKeyForOrganizationRequest {
  string organization_id = 1; // Organization ID whose API key to revoke
}

// Revoke DNS Delegation API Key For Organization Response
message RevokeDNSDelegationAPIKeyForOrganizationResponse {
  bool success = 1;
  string message = 2; // Success message
}

// List DNS Delegation API Keys Request
message ListDNSDelegationAPIKeysRequest {
  optional string organization_id = 1; // Filter by organization ID (optional)
}

// DNS Delegation API Key Info
message DNSDelegationAPIKeyInfo {
  string id = 1; // API key ID
  string description = 2; // Description
  string source_api = 3; // Source API URL (if set)
  string organization_id = 4; // Organization ID (if set)
  bool is_active = 5; // Whether the key is active
  google.protobuf.Timestamp created_at = 6; // When the key was created
  google.protobuf.Timestamp revoked_at = 7; // When the key was revoked (if revoked)
  string stripe_subscription_id = 8; // Stripe subscription ID (if linked to subscription)
}

// List DNS Delegation API Keys Response
message ListDNSDelegationAPIKeysResponse {
  repeated DNSDelegationAPIKeyInfo api_keys = 1;
}

// Abuse Detection

// Get Abuse Detection Request
message GetAbuseDetectionRequest {}

// Abuse Detection Response
message GetAbuseDetectionResponse {
  repeated SuspiciousOrganization suspicious_organizations = 1;
  repeated SuspiciousActivity suspicious_activities = 2;
  AbuseMetrics metrics = 3;
}

// Suspicious Organization
message SuspiciousOrganization {
  string organization_id = 1;
  string organization_name = 2;
  string reason = 3; // Why it's flagged
  int64 risk_score = 4; // 0-100, higher is more suspicious
  int64 created_count_24h = 5; // Resources created in last 24h
  int64 failed_deployments_24h = 6; // Failed deployments in last 24h
  int64 total_credits_spent = 7; // Total credits spent
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp last_activity = 9;
}

// Suspicious Activity
message SuspiciousActivity {
  string id = 1;
  string organization_id = 2;
  string activity_type = 3; // "rapid_creation", "failed_payments", "unusual_usage", etc.
  string description = 4;
  int64 severity = 5; // 0-100
  google.protobuf.Timestamp occurred_at = 6;
}

// Abuse Metrics
message AbuseMetrics {
  int64 total_suspicious_orgs = 1;
  int64 high_risk_orgs = 2; // Risk score > 70
  int64 rapid_creations_24h = 3; // Organizations with >10 resources created in 24h
  int64 failed_payment_attempts_24h = 4;
  int64 unusual_usage_spikes_24h = 5;
}

// Income Overview

// Get Income Overview Request
message GetIncomeOverviewRequest {
  optional string start_date = 1; // ISO 8601 date string (optional, defaults to 30 days ago)
  optional string end_date = 2; // ISO 8601 date string (optional, defaults to now)
}

// Income Overview Response
message GetIncomeOverviewResponse {
  IncomeSummary summary = 1;
  repeated MonthlyIncome monthly_income = 2;
  repeated TopCustomer top_customers = 3;
  repeated BillingTransaction transactions = 4;
  PaymentMetrics payment_metrics = 5;
}

// Income Summary
message IncomeSummary {
  double total_revenue = 1; // Total revenue in period
  double monthly_recurring_revenue = 2; // Estimated MRR
  double average_monthly_revenue = 3; // Average monthly revenue
  int64 total_transactions = 4;
  double total_refunds = 5;
  double net_revenue = 6; // Revenue minus refunds
  double estimated_monthly_income = 7; // Estimated monthly income from all orgs based on usage
}

// Monthly Income
message MonthlyIncome {
  string month = 1; // YYYY-MM format
  double revenue = 2;
  int64 transaction_count = 3;
  double refunds = 4;
}

// Top Customer
message TopCustomer {
  string organization_id = 1;
  string organization_name = 2;
  double total_revenue = 3;
  int64 transaction_count = 4;
  google.protobuf.Timestamp first_payment = 5;
  google.protobuf.Timestamp last_payment = 6;
}

// Billing Transaction
message BillingTransaction {
  string id = 1;
  string organization_id = 2;
  string organization_name = 3;
  string type = 4; // "payment", "refund", "credit_add", "credit_remove"
  double amount_cents = 5;
  string currency = 6;
  string status = 7; // "succeeded", "failed", "pending"
  optional string stripe_invoice_id = 8;
  optional string stripe_payment_intent_id = 9;
  optional string note = 10;
  google.protobuf.Timestamp created_at = 11;
}

// Payment Metrics
message PaymentMetrics {
  double success_rate = 1; // Percentage of successful payments
  int64 successful_payments = 2;
  int64 failed_payments = 3;
  int64 pending_payments = 4;
  double average_payment_amount = 5;
  double largest_payment = 6;
}

// Invoice Management

// List All Invoices Request
message ListAllInvoicesRequest {
  optional string organization_id = 1; // Filter by organization ID (optional)
  optional string status = 2; // Filter by status: "draft", "open", "paid", "uncollectible", "void" (optional)
  optional int32 limit = 3; // Limit number of results (default: 50, max: 500)
  optional string start_date = 4; // ISO 8601 date string (optional)
  optional string end_date = 5; // ISO 8601 date string (optional)
}

// List All Invoices Response
message ListAllInvoicesResponse {
  repeated InvoiceWithOrganization invoices = 1;
  bool has_more = 2;
  int64 total_count = 3;
}

// Invoice with Organization Info
message InvoiceWithOrganization {
  obiente.cloud.billing.v1.Invoice invoice = 1;
  string organization_id = 2;
  string organization_name = 3;
  string customer_email = 4;
}

// Send Invoice Reminder Request
message SendInvoiceReminderRequest {
  string invoice_id = 1; // Stripe invoice ID
}

// Send Invoice Reminder Response
message SendInvoiceReminderResponse {
  bool success = 1;
  string message = 2;
}

// Plan Management

// List Plans Request
message ListPlansRequest {}

// List Plans Response
message ListPlansResponse {
  repeated Plan plans = 1;
}

// Create Plan Request
message CreatePlanRequest {
  string name = 1;
  int32 cpu_cores = 2;
  int64 memory_bytes = 3;
  int32 deployments_max = 4;
  int64 bandwidth_bytes_month = 5;
  int64 storage_bytes = 6;
  int64 minimum_payment_cents = 7; // Minimum payment in cents to automatically upgrade to this plan
  int64 monthly_free_credits_cents = 8; // Monthly free credits in cents granted to organizations on this plan
  string description = 9; // Optional description of the plan
}

// Create Plan Response
message CreatePlanResponse {
  Plan plan = 1;
}

// Update Plan Request
message UpdatePlanRequest {
  string id = 1;
  optional string name = 2;
  optional int32 cpu_cores = 3;
  optional int64 memory_bytes = 4;
  optional int32 deployments_max = 5;
  optional int64 bandwidth_bytes_month = 6;
  optional int64 storage_bytes = 7;
  optional int64 minimum_payment_cents = 8;
  optional int64 monthly_free_credits_cents = 9;
  optional string description = 10;
}

// Update Plan Response
message UpdatePlanResponse {
  Plan plan = 1;
}

// Delete Plan Request
message DeletePlanRequest {
  string id = 1;
}

// Delete Plan Response
message DeletePlanResponse {
  bool success = 1;
}

// Plan
message Plan {
  string id = 1;
  string name = 2;
  int32 cpu_cores = 3;
  int64 memory_bytes = 4;
  int32 deployments_max = 5;
  int64 bandwidth_bytes_month = 6;
  int64 storage_bytes = 7;
  int64 minimum_payment_cents = 8; // Minimum payment in cents to automatically upgrade to this plan
  int64 monthly_free_credits_cents = 9; // Monthly free credits in cents granted to organizations on this plan
  string description = 10;
}

// Assign Plan To Organization Request
message AssignPlanToOrganizationRequest {
  string organization_id = 1;
  string plan_id = 2;
}

// Assign Plan To Organization Response
message AssignPlanToOrganizationResponse {
  bool success = 1;
  string message = 2;
}

// User Management

// List Users Request
message ListUsersRequest {
  optional int32 page = 1; // Page number (default: 1)
  optional int32 per_page = 2; // Results per page (default: 50, max: 100)
  optional string search = 3; // Search by email, name, or user ID
}

// List Users Response
message ListUsersResponse {
  repeated UserInfo users = 1;
  SuperadminPagination pagination = 2;
}

// Get User Request
message GetUserRequest {
  string user_id = 1; // User ID to fetch
}

// Get User Response
message GetUserResponse {
  UserInfo user = 1;
  repeated UserOrganization organizations = 2; // Organizations this user belongs to
}

// User Info
message UserInfo {
  string id = 1;
  string email = 2;
  string name = 3;
  string preferred_username = 4;
  string locale = 5;
  bool email_verified = 6;
  optional string avatar_url = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  repeated string roles = 10; // User roles (e.g., "superadmin")
}

// User Organization
message UserOrganization {
  string organization_id = 1;
  string organization_name = 2;
  string role = 3; // Member role in this organization
  string status = 4; // "active" or "invited"
  google.protobuf.Timestamp joined_at = 5;
}

// Pagination
message SuperadminPagination {
  int32 page = 1;
  int32 per_page = 2;
  int32 total = 3;
  int32 total_pages = 4;
}