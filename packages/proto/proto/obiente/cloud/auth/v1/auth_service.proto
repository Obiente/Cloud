syntax = "proto3";

package obiente.cloud.auth.v1;

option go_package = "api/gen/proto/obiente/cloud/auth/v1;authv1";

import "google/protobuf/timestamp.proto";

service AuthService {
  // Get public configuration (no authentication required)
  rpc GetPublicConfig(GetPublicConfigRequest) returns (GetPublicConfigResponse);
  
  // Login with email and password using service account
  // This endpoint does not require authentication (public)
  rpc Login(LoginRequest) returns (LoginResponse);
  
  // Get current authenticated user
  rpc GetCurrentUser(GetCurrentUserRequest) returns (GetCurrentUserResponse);
  
  // Update user profile information
  rpc UpdateUserProfile(UpdateUserProfileRequest) returns (UpdateUserProfileResponse);
  
  // GitHub Integration
  // Connect GitHub account by storing OAuth token
  rpc ConnectGitHub(ConnectGitHubRequest) returns (ConnectGitHubResponse);
  
  // Disconnect GitHub account
  rpc DisconnectGitHub(DisconnectGitHubRequest) returns (DisconnectGitHubResponse);
  
  // Get GitHub connection status
  rpc GetGitHubStatus(GetGitHubStatusRequest) returns (GetGitHubStatusResponse);
  
  // Organization GitHub Integration
  // Connect organization GitHub account by storing OAuth token
  rpc ConnectOrganizationGitHub(ConnectOrganizationGitHubRequest) returns (ConnectOrganizationGitHubResponse);
  
  // Disconnect organization GitHub account
  rpc DisconnectOrganizationGitHub(DisconnectOrganizationGitHubRequest) returns (DisconnectOrganizationGitHubResponse);
  
  // List all GitHub integrations (user and organizations)
  rpc ListGitHubIntegrations(ListGitHubIntegrationsRequest) returns (ListGitHubIntegrationsResponse);
}

// Public Configuration Messages
message GetPublicConfigRequest {}

message GetPublicConfigResponse {
  bool billing_enabled = 1;
  bool self_hosted = 2;
  bool disable_auth = 3;
}

// Empty request for getting current user
message GetCurrentUserRequest {}

message GetCurrentUserResponse {
  User user = 1;
}

message User {
  string id = 1;
  string email = 2;
  string name = 3;
  string avatar_url = 4;
  google.protobuf.Timestamp created_at = 5;
  string timezone = 6;
  // Extended Zitadel userinfo fields
  string given_name = 7;
  string family_name = 8;
  string preferred_username = 9;
  bool email_verified = 10;
  string locale = 11;
  google.protobuf.Timestamp updated_at = 12;
  repeated string roles = 13;
}

// GitHub Integration Messages
message ConnectGitHubRequest {
  string access_token = 1; // GitHub OAuth access token
  string username = 2;     // GitHub username
  string scope = 3;        // Granted OAuth scopes
}

message ConnectGitHubResponse {
  bool success = 1;
  string username = 2; // GitHub username
}

message DisconnectGitHubRequest {}

message DisconnectGitHubResponse {
  bool success = 1;
}

message GetGitHubStatusRequest {}

message GetGitHubStatusResponse {
  bool connected = 1;
  string username = 2; // GitHub username if connected
}

// Organization GitHub Integration Messages
message ConnectOrganizationGitHubRequest {
  string organization_id = 1;
  string access_token = 2; // GitHub OAuth access token
  string username = 3;     // GitHub username
  string scope = 4;        // Granted OAuth scopes
}

message ConnectOrganizationGitHubResponse {
  bool success = 1;
  string username = 2; // GitHub username
}

message DisconnectOrganizationGitHubRequest {
  string organization_id = 1;
}

message DisconnectOrganizationGitHubResponse {
  bool success = 1;
}

message ListGitHubIntegrationsRequest {}

message GitHubIntegrationInfo {
  string id = 1;
  string username = 2;
  string scope = 3;
  bool is_user = 4; // true if user integration, false if organization
  string organization_id = 5; // Only set if is_user is false
  string organization_name = 6; // Only set if is_user is false
  google.protobuf.Timestamp connected_at = 7;
}

message ListGitHubIntegrationsResponse {
  repeated GitHubIntegrationInfo integrations = 1;
}

// User Profile Update Messages
message UpdateUserProfileRequest {
  // Optional: Update given name (first name)
  optional string given_name = 1;
  // Optional: Update family name (last name)
  optional string family_name = 2;
  // Optional: Update display name
  optional string name = 3;
  // Optional: Update preferred username
  optional string preferred_username = 4;
  // Optional: Update locale
  optional string locale = 5;
}

message UpdateUserProfileResponse {
  User user = 1; // Updated user information
}

// Login Messages
message LoginRequest {
  string email = 1;
  string password = 2;
  bool remember_me = 3; // Whether to set a longer session expiry
}

message LoginResponse {
  bool success = 1;
  string access_token = 2; // OAuth2 access token
  string refresh_token = 3; // OAuth2 refresh token
  int32 expires_in = 4; // Token expiry in seconds
  string message = 5; // Error message if success is false
}