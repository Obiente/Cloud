syntax = "proto3";

package obiente.cloud.deployments.v1;

option go_package = "github.com/obiente/cloud/apps/shared/proto/obiente/cloud/deployments/v1;deploymentsv1";

import "google/protobuf/timestamp.proto";
import "obiente/cloud/organizations/v1/organization_service.proto";
import "obiente/cloud/common/v1/common.proto";

// Enumerations for typed fields used by the frontend
// DeploymentType represents the runtime/language type of the application
enum DeploymentType {
  DEPLOYMENT_TYPE_UNSPECIFIED = 0;
  DOCKER = 1;          // Docker container (from Dockerfile or compose)
  STATIC = 2;          // Static site hosting
  NODE = 3;            // Node.js application
  GO = 4;              // Go application
  PYTHON = 5;          // Python application
  RUBY = 6;            // Ruby/Rails application
  RUST = 7;            // Rust application
  JAVA = 8;            // Java application
  PHP = 9;             // PHP application
  GENERIC = 10;        // Generic/unknown runtime (use when can't detect)
}


// Build strategy determines how the deployment is built and deployed
enum BuildStrategy {
  BUILD_STRATEGY_UNSPECIFIED = 0;
  RAILPACK = 1;        // Railpack (Nixpacks variant, can build any language including Rails)
  NIXPACKS = 2;         // Nixpacks buildpacks (can build any language)
  DOCKERFILE = 3;       // Build from Dockerfile
  PLAIN_COMPOSE = 4;    // Plain Docker Compose (uses compose YAML from database, no repository)
  COMPOSE_REPO = 6;     // Compose from Repository (clones repo and uses compose file from repo)
  STATIC_SITE = 5;      // Static site hosting
}

enum Environment {
  ENVIRONMENT_UNSPECIFIED = 0;
  PRODUCTION = 1;
  STAGING = 2;
  DEVELOPMENT = 3;
}

enum DeploymentStatus {
  DEPLOYMENT_STATUS_UNSPECIFIED = 0;
  CREATED = 1;
  BUILDING = 2;
  RUNNING = 3;
  STOPPED = 4;
  FAILED = 5;
  DEPLOYING = 6;
}

enum BuildStatus {
  BUILD_STATUS_UNSPECIFIED = 0;
  BUILD_PENDING = 1;
  BUILD_BUILDING = 2;
  BUILD_SUCCESS = 3;
  BUILD_FAILED = 4;
}

service DeploymentService {
  // List organization deployments
  rpc ListDeployments(ListDeploymentsRequest) returns (ListDeploymentsResponse);
  
  // Create new deployment
  rpc CreateDeployment(CreateDeploymentRequest) returns (CreateDeploymentResponse);
  
  // Get deployment details
  rpc GetDeployment(GetDeploymentRequest) returns (GetDeploymentResponse);
  
  // Update deployment configuration
  rpc UpdateDeployment(UpdateDeploymentRequest) returns (UpdateDeploymentResponse);
  
  // Trigger deployment
  rpc TriggerDeployment(TriggerDeploymentRequest) returns (TriggerDeploymentResponse);
  
  // Stream deployment status updates
  rpc StreamDeploymentStatus(StreamDeploymentStatusRequest) returns (stream DeploymentStatusUpdate);
  
  // Get deployment logs
  rpc GetDeploymentLogs(GetDeploymentLogsRequest) returns (GetDeploymentLogsResponse);

  // Stream deployment logs (tail/follow)
  rpc StreamDeploymentLogs(StreamDeploymentLogsRequest) returns (stream DeploymentLogLine);

  // Stream build logs during deployment (live build output)
  rpc StreamBuildLogs(StreamBuildLogsRequest) returns (stream DeploymentLogLine);

  // Get deployment metrics (real-time or historical)
  rpc GetDeploymentMetrics(GetDeploymentMetricsRequest) returns (GetDeploymentMetricsResponse);

  // Stream real-time deployment metrics
  rpc StreamDeploymentMetrics(StreamDeploymentMetricsRequest) returns (stream DeploymentMetric);

  // Get aggregated usage for a deployment
  rpc GetDeploymentUsage(GetDeploymentUsageRequest) returns (GetDeploymentUsageResponse);

  // Start a stopped deployment
  rpc StartDeployment(StartDeploymentRequest) returns (StartDeploymentResponse);

  // Stop a running deployment
  rpc StopDeployment(StopDeploymentRequest) returns (StopDeploymentResponse);

  // Delete a deployment
  rpc DeleteDeployment(DeleteDeploymentRequest) returns (DeleteDeploymentResponse);

  // Restart a deployment
  rpc RestartDeployment(RestartDeploymentRequest) returns (RestartDeploymentResponse);

  // Scale a deployment
  rpc ScaleDeployment(ScaleDeploymentRequest) returns (ScaleDeploymentResponse);

  // Get deployment environment variables
  rpc GetDeploymentEnvVars(GetDeploymentEnvVarsRequest) returns (GetDeploymentEnvVarsResponse);

  // Update deployment environment variables
  rpc UpdateDeploymentEnvVars(UpdateDeploymentEnvVarsRequest) returns (UpdateDeploymentEnvVarsResponse);

  // Get deployment docker compose configuration
  rpc GetDeploymentCompose(GetDeploymentComposeRequest) returns (GetDeploymentComposeResponse);

  // Validate deployment docker compose configuration (validation only, no save)
  rpc ValidateDeploymentCompose(ValidateDeploymentComposeRequest) returns (ValidateDeploymentComposeResponse);

  // Update deployment docker compose configuration
  rpc UpdateDeploymentCompose(UpdateDeploymentComposeRequest) returns (UpdateDeploymentComposeResponse);

  // GitHub integration
  // List GitHub repositories for the authenticated user
  rpc ListGitHubRepos(ListGitHubReposRequest) returns (ListGitHubReposResponse);
  
  // Get branches for a GitHub repository
  rpc GetGitHubBranches(GetGitHubBranchesRequest) returns (GetGitHubBranchesResponse);
  
  // Get file content from a GitHub repository
  rpc GetGitHubFile(GetGitHubFileRequest) returns (GetGitHubFileResponse);

  // Build history management
  // List builds for a deployment
  rpc ListBuilds(ListBuildsRequest) returns (ListBuildsResponse);
  
  // Get details of a specific build
  rpc GetBuild(GetBuildRequest) returns (GetBuildResponse);
  
  // Get build logs for a specific build
  rpc GetBuildLogs(GetBuildLogsRequest) returns (GetBuildLogsResponse);
  
  // Revert deployment to a previous build
  rpc RevertToBuild(RevertToBuildRequest) returns (RevertToBuildResponse);
  
  // Delete a build from history
  rpc DeleteBuild(DeleteBuildRequest) returns (DeleteBuildResponse);
  
  // List all available GitHub integrations for the current user
  rpc ListAvailableGitHubIntegrations(ListAvailableGitHubIntegrationsRequest) returns (ListAvailableGitHubIntegrationsResponse);

  // Terminal access
  // Stream terminal with bidirectional streaming (replaces StreamTerminalOutput + SendTerminalInput)
  // Use this for better input/output synchronization
  rpc StreamTerminal(stream TerminalInput) returns (stream TerminalOutput);
  
  // DEPRECATED: Use StreamTerminal instead for bidirectional streaming
  // Stream terminal output from a deployment container
  // Input is sent via SendTerminalInput RPC
  rpc StreamTerminalOutput(StreamTerminalOutputRequest) returns (stream TerminalOutput);
  
  // DEPRECATED: Use StreamTerminal instead for bidirectional streaming
  // Send input to an active terminal session
  rpc SendTerminalInput(SendTerminalInputRequest) returns (SendTerminalInputResponse);

  // File browser
  // List files in a deployment container
  rpc ListContainerFiles(ListContainerFilesRequest) returns (ListContainerFilesResponse);
  
  // Get file content from a deployment container
  rpc GetContainerFile(GetContainerFileRequest) returns (GetContainerFileResponse);
  
  // Upload files to a deployment container
  rpc UploadContainerFiles(UploadContainerFilesRequest) returns (UploadContainerFilesResponse);

  // Delete one or more files/directories in a deployment container
  rpc DeleteContainerEntries(DeleteContainerEntriesRequest) returns (DeleteContainerEntriesResponse);

  // Rename or move a file/directory within a deployment container
  rpc RenameContainerEntry(RenameContainerEntryRequest) returns (RenameContainerEntryResponse);

  // Create an empty file or directory within a deployment container
  rpc CreateContainerEntry(CreateContainerEntryRequest) returns (CreateContainerEntryResponse);

  // Write/update file contents in a deployment container
  rpc WriteContainerFile(WriteContainerFileRequest) returns (WriteContainerFileResponse);
  
  // Extract a zip file to a destination directory
  rpc ExtractDeploymentFile(ExtractDeploymentFileRequest) returns (ExtractDeploymentFileResponse);
  
  // Create a zip archive from files or folders
  rpc CreateDeploymentFileArchive(CreateDeploymentFileArchiveRequest) returns (CreateDeploymentFileArchiveResponse);

  // Routing configuration
  // Get all routing rules for a deployment
  rpc GetDeploymentRoutings(GetDeploymentRoutingsRequest) returns (GetDeploymentRoutingsResponse);
  
  // Update routing rules for a deployment (replaces all existing rules)
  rpc UpdateDeploymentRoutings(UpdateDeploymentRoutingsRequest) returns (UpdateDeploymentRoutingsResponse);
  
  // Get available service names from Docker Compose
  rpc GetDeploymentServiceNames(GetDeploymentServiceNamesRequest) returns (GetDeploymentServiceNamesResponse);

  // Domain verification
  // Get verification token for a custom domain
  rpc GetDomainVerificationToken(GetDomainVerificationTokenRequest) returns (GetDomainVerificationTokenResponse);
  
  // Verify domain ownership via DNS TXT record
  rpc VerifyDomainOwnership(VerifyDomainOwnershipRequest) returns (VerifyDomainOwnershipResponse);

  // List all containers for a deployment
  rpc ListDeploymentContainers(ListDeploymentContainersRequest) returns (ListDeploymentContainersResponse);

  // Stream logs from a specific container
  rpc StreamContainerLogs(StreamContainerLogsRequest) returns (stream DeploymentLogLine);

  // Start a specific container
  rpc StartContainer(StartContainerRequest) returns (StartContainerResponse);

  // Stop a specific container
  rpc StopContainer(StopContainerRequest) returns (StopContainerResponse);

  // Restart a specific container
  rpc RestartContainer(RestartContainerRequest) returns (RestartContainerResponse);
}

message ListDeploymentsRequest {
  string organization_id = 1;
  optional DeploymentStatus status = 2;
  int32 page = 3;
  int32 per_page = 4;
}

message ListDeploymentsResponse {
  repeated Deployment deployments = 1;
  obiente.cloud.common.v1.Pagination pagination = 2;
}

message CreateDeploymentRequest {
  string organization_id = 1;
  string name = 2;
  Environment environment = 3; // Environment (production/staging/development)
  repeated string groups = 4; // Optional groups/labels for organizing deployments
}

message CreateDeploymentResponse {
  Deployment deployment = 1;
}

message GetDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message GetDeploymentResponse {
  Deployment deployment = 1;
}

message UpdateDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
  optional string name = 3;
  optional string repository_url = 4;
  optional string github_integration_id = 14; // GitHub integration ID used for this deployment
  optional string branch = 5;
  optional string build_command = 6;
  optional string install_command = 7;
  optional string start_command = 17; // Start command for running the application
  optional string dockerfile_path = 12; // Path to Dockerfile (relative to repo root)
  optional string compose_file_path = 13; // Path to compose file (relative to repo root)
  optional string build_path = 18; // Working directory for build (relative to repo root, defaults to ".")
  optional string build_output_path = 19; // Path to built output files (relative to repo root, auto-detected if empty)
  optional bool use_nginx = 20; // Use nginx for static deployments
  optional string nginx_config = 21; // Custom nginx configuration (optional, uses default if empty)
  optional string domain = 8;
  repeated string custom_domains = 9;
  optional int32 port = 10;
  optional BuildStrategy build_strategy = 11; // build strategy enum
  optional Environment environment = 15; // Environment (production/staging/development)
  repeated string groups = 16; // Optional groups/labels for organizing deployments
}

message UpdateDeploymentResponse {
  Deployment deployment = 1;
}

message TriggerDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message TriggerDeploymentResponse {
  string deployment_id = 1;
  string status = 2;
}

message StreamDeploymentStatusRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message DeploymentStatusUpdate {
  string deployment_id = 1;
  DeploymentStatus status = 2;
  string health_status = 3;
  optional string message = 4;
  google.protobuf.Timestamp timestamp = 5;
}

message GetDeploymentLogsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  optional int32 lines = 3;
  optional bool follow = 4;
}

message GetDeploymentLogsResponse {
  repeated string logs = 1;
}

message StreamDeploymentLogsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  optional int32 tail = 3; // number of lines to tail before following
  optional string container_id = 4; // Optional: stream logs from a specific container. If not specified, uses first container.
  optional string service_name = 5; // Optional: stream logs from a specific service. If container_id is specified, this is ignored.
}

message StreamBuildLogsRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message DeploymentLogLine {
  string deployment_id = 1;
  string line = 2;
  google.protobuf.Timestamp timestamp = 3;
  bool stderr = 4; // Deprecated: Use log_level instead. Kept for backward compatibility.
  obiente.cloud.common.v1.LogLevel log_level = 5; // Log level (INFO, WARN, ERROR, DEBUG, TRACE)
}

message StartDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message StartDeploymentResponse {
  Deployment deployment = 1;
}

message StopDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message StopDeploymentResponse {
  Deployment deployment = 1;
}

message DeleteDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message DeleteDeploymentResponse {
  bool success = 1;
}

message RestartDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message RestartDeploymentResponse {
  Deployment deployment = 1;
}

message ScaleDeploymentRequest {
  string organization_id = 1;
  string deployment_id = 2;
  int32 replicas = 3;
}

message ScaleDeploymentResponse {
  Deployment deployment = 1;
}

message GetDeploymentEnvVarsRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message GetDeploymentEnvVarsResponse {
  // Raw .env file content (preserves comments and formatting)
  string env_file_content = 1;
}

message UpdateDeploymentEnvVarsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  // Raw .env file content (preserves comments and formatting)
  string env_file_content = 3;
}

message UpdateDeploymentEnvVarsResponse {
  Deployment deployment = 1;
}

message GetDeploymentComposeRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message GetDeploymentComposeResponse {
  string compose_yaml = 1;
}

message ValidateDeploymentComposeRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string compose_yaml = 3;
}

message ValidateDeploymentComposeResponse {
  repeated ComposeValidationError validation_errors = 1;
  optional string validation_error = 2; // Deprecated: Use validation_errors instead
}

message UpdateDeploymentComposeRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string compose_yaml = 3;
}

message UpdateDeploymentComposeResponse {
  Deployment deployment = 1;
  optional string validation_error = 2; // Deprecated: Use validation_errors instead
  repeated ComposeValidationError validation_errors = 3;
}

message ComposeValidationError {
  int32 line = 1; // 1-based line number
  int32 column = 2; // 1-based column number
  string message = 3;
  string severity = 4; // "error" or "warning"
  int32 start_line = 5; // Start line for multi-line errors
  int32 end_line = 6; // End line for multi-line errors
  int32 start_column = 7; // Start column
  int32 end_column = 8; // End column
}

message ListGitHubReposRequest {
  string organization_id = 1; // Organization ID to use for GitHub token (optional, will use user token if not provided)
  string integration_id = 2; // Optional: use specific GitHub integration ID
  int32 page = 3;
  int32 per_page = 4;
}

message GitHubRepo {
  string id = 1;
  string name = 2;
  string full_name = 3;
  string description = 4;
  string url = 5;
  bool is_private = 6;
  string default_branch = 7;
}

message ListGitHubReposResponse {
  repeated GitHubRepo repos = 1;
  int32 total = 2;
}

message GetGitHubBranchesRequest {
  string organization_id = 1; // Organization ID to use for GitHub token (optional, will use user token if not provided)
  string integration_id = 2; // Optional: use specific GitHub integration ID
  string repo_full_name = 3; // e.g., "owner/repo"
}

message GitHubBranch {
  string name = 1;
  bool is_default = 2;
  string sha = 3;
}

message GetGitHubBranchesResponse {
  repeated GitHubBranch branches = 1;
}

message GetGitHubFileRequest {
  string organization_id = 1; // Organization ID to use for GitHub token (optional, will use user token if not provided)
  string integration_id = 2; // Optional: use specific GitHub integration ID
  string repo_full_name = 3; // e.g., "owner/repo"
  string branch = 4;
  string path = 5; // e.g., "docker-compose.yml"
}

message GetGitHubFileResponse {
  string content = 1;
  string encoding = 2; // "base64" or "text"
  int64 size = 3;
}

message ListAvailableGitHubIntegrationsRequest {
  string organization_id = 1; // Optional: filter integrations for this organization
}

message GitHubIntegrationOption {
  string id = 1;
  string username = 2;
  bool is_user = 3; // true if user integration, false if organization
  string obiente_org_id = 4; // Obiente cloud organization ID (only set if is_user is false)
  string obiente_org_name = 5; // Obiente cloud organization name (only set if is_user is false)
}

message ListAvailableGitHubIntegrationsResponse {
  repeated GitHubIntegrationOption integrations = 1;
}

message StreamTerminalOutputRequest {
  string organization_id = 1;
  string deployment_id = 2;
  int32 cols = 3; // Terminal width
  int32 rows = 4; // Terminal height
}

message SendTerminalInputRequest {
  string organization_id = 1;
  string deployment_id = 2;
  bytes input = 3; // User keyboard input
  int32 cols = 4; // Terminal width (for resize)
  int32 rows = 5; // Terminal height (for resize)
}

message SendTerminalInputResponse {
  bool success = 1;
}

message TerminalInput {
  string organization_id = 1;
  string deployment_id = 2;
  string container_id = 6; // Optional: specific container ID to connect to
  string service_name = 7; // Optional: service name to connect to (for Docker Compose)
  bytes input = 3; // User keyboard input
  int32 cols = 4; // Terminal width (for resize/initial setup)
  int32 rows = 5; // Terminal height (for resize/initial setup)
}

message TerminalOutput {
  bytes output = 1; // Terminal stdout/stderr
  bool exit = 2; // Whether the terminal session has ended
}


message VolumeInfo {
  string name = 1; // Volume name
  string mount_point = 2; // Mount point inside container (e.g., "/data")
  string source = 3; // Volume source path on host
  bool is_persistent = 4; // Whether this is a persistent volume
}

message ListContainerFilesRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string path = 3; // Directory path (default: "/")
  optional string volume_name = 4; // If specified, list files from this volume instead of container filesystem
  bool list_volumes = 5; // If true, return list of available volumes instead of files
  optional string cursor = 6;
  optional int32 page_size = 7;
  optional string container_id = 8; // Optional: use a specific container. If not specified, uses first container.
  optional string service_name = 9; // Optional: use a specific service. If container_id is specified, this is ignored.
}

message ContainerFile {
  string name = 1;
  string path = 2;
  bool is_directory = 3;
  int64 size = 4;
  string permissions = 5;
  optional string volume_name = 6; // If this file is in a volume, the volume name
  optional string owner = 7;
  optional string group = 8;
  optional uint32 mode_octal = 9;
  optional bool is_symlink = 10;
  optional string symlink_target = 11;
  optional string mime_type = 12;
  optional google.protobuf.Timestamp modified_time = 13;
  optional google.protobuf.Timestamp created_time = 14;
}

message ListContainerFilesResponse {
  repeated ContainerFile files = 1;
  string current_path = 2;
  repeated VolumeInfo volumes = 3; // Available persistent volumes (only when list_volumes=true)
  bool is_volume = 4; // Whether the current listing is from a volume
  bool container_running = 5; // Whether the container is currently running
  bool has_more = 6;
  optional string next_cursor = 7;
}

message GetContainerFileRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string path = 3; // File path
  optional string volume_name = 4; // If specified, read file from this volume instead of container filesystem
  optional string container_id = 5; // Optional: use a specific container. If not specified, uses first container.
  optional string service_name = 6; // Optional: use a specific service. If container_id is specified, this is ignored.
}

message GetContainerFileResponse {
  string content = 1;
  string encoding = 2; // "text" or "base64"
  int64 size = 3;
  optional bool truncated = 4;
  optional ContainerFile metadata = 5;
}

message UploadContainerFilesRequest {
  UploadContainerFilesMetadata metadata = 1; // Metadata about the upload
  bytes tar_data = 2; // Complete tar archive containing all files
}

message UploadContainerFilesMetadata {
  string organization_id = 1;
  string deployment_id = 2;
  string destination_path = 3; // Directory path where files should be extracted (default: "/")
  repeated FileMetadata files = 4; // Metadata about files being uploaded
  optional string volume_name = 5; // If specified, upload files to this volume instead of container filesystem
  optional string container_id = 6; // Optional: use a specific container. If not specified, uses first container.
  optional string service_name = 7; // Optional: use a specific service. If container_id is specified, this is ignored.
}

message FileMetadata {
  string name = 1; // File name
  int64 size = 2; // File size in bytes
  bool is_directory = 3; // Whether this is a directory
  string path = 4; // Relative path within the archive
}

message UploadContainerFilesResponse {
  bool success = 1;
  optional string error = 2;
  int32 files_uploaded = 3; // Number of files successfully uploaded
}

enum ContainerEntryType {
  CONTAINER_ENTRY_TYPE_UNSPECIFIED = 0;
  CONTAINER_ENTRY_TYPE_FILE = 1;
  CONTAINER_ENTRY_TYPE_DIRECTORY = 2;
  CONTAINER_ENTRY_TYPE_SYMLINK = 3;
}

message DeleteContainerEntriesRequest {
  string organization_id = 1;
  string deployment_id = 2;
  repeated string paths = 3;
  optional string volume_name = 4;
  bool recursive = 5;
  bool force = 6;
}

message DeleteContainerEntriesError {
  string path = 1;
  string message = 2;
}

message DeleteContainerEntriesResponse {
  bool success = 1;
  repeated string deleted_paths = 2;
  repeated DeleteContainerEntriesError errors = 3;
}

message RenameContainerEntryRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string source_path = 3;
  string target_path = 4;
  optional string volume_name = 5;
  bool overwrite = 6;
}

message RenameContainerEntryResponse {
  bool success = 1;
  optional ContainerFile entry = 2;
}

message CreateContainerEntryRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string parent_path = 3;
  string name = 4;
  ContainerEntryType type = 5;
  optional string template = 6; // Optional template identifier for seeded content (required for symlinks - target path)
  optional string volume_name = 7;
  optional uint32 mode_octal = 8;
  optional string container_id = 9; // Specific container to create entry in (for compose deployments)
  optional string service_name = 10; // Service name to create entry in (for compose deployments)
}

message CreateContainerEntryResponse {
  ContainerFile entry = 1;
}

message WriteContainerFileRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string path = 3;
  optional string volume_name = 4;
  string content = 5;
  string encoding = 6; // "text" or "base64"
  bool create_if_missing = 7;
  optional uint32 mode_octal = 8;
}

message WriteContainerFileResponse {
  bool success = 1;
  optional ContainerFile entry = 2;
  optional string error = 3;
}

message ExtractDeploymentFileRequest {
  string deployment_id = 1;
  string organization_id = 2;
  string zip_path = 3; // Path to the zip file to extract (from common.ExtractServerFileRequest)
  string destination_path = 4; // Directory path where files should be extracted (from common.ExtractServerFileRequest)
  optional string volume_name = 5; // If specified, extract to this volume instead of container filesystem (from common.ExtractServerFileRequest)
  optional string container_id = 6; // If specified, extract to this container
  optional string service_name = 7; // If specified, extract to container with this service name
}

message ExtractDeploymentFileResponse {
  bool success = 1; // From common.ExtractServerFileResponse
  optional string error = 2; // From common.ExtractServerFileResponse
  int32 files_extracted = 3; // Number of files successfully extracted (from common.ExtractServerFileResponse)
}

message CreateDeploymentFileArchiveRequest {
  string deployment_id = 1;
  string organization_id = 2;
  obiente.cloud.common.v1.CreateServerFileArchiveRequest archive_request = 3; // Shared archive request
  optional string volume_name = 4; // If specified, create archive in this volume instead of container filesystem
  optional string container_id = 5; // If specified, create archive in this container
  optional string service_name = 6; // If specified, create archive in container with this service name
}

message CreateDeploymentFileArchiveResponse {
  obiente.cloud.common.v1.CreateServerFileArchiveResponse archive_response = 1; // Shared archive response
}
 
 // Routing configuration messages
 message RoutingRule {
  string id = 1;
  string deployment_id = 2;
  string domain = 3;
  string service_name = 4; // Service name (e.g., "api", "web", "admin", "default")
  string path_prefix = 5; // Optional path prefix (e.g., "/api")
  int32 target_port = 6;
  string protocol = 7; // "http", "https", "grpc"
  bool ssl_enabled = 8;
  string ssl_cert_resolver = 9;
}

message GetDeploymentRoutingsRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message GetDeploymentRoutingsResponse {
  repeated RoutingRule rules = 1;
}

message UpdateDeploymentRoutingsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  repeated RoutingRule rules = 3; // Replace all existing rules with these
}

message UpdateDeploymentRoutingsResponse {
  repeated RoutingRule rules = 1;
}

message GetDeploymentServiceNamesRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message GetDeploymentServiceNamesResponse {
  repeated string service_names = 1;
}

// Domain verification messages
message GetDomainVerificationTokenRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string domain = 3;
}

message GetDomainVerificationTokenResponse {
  string domain = 1;
  string token = 2;
  string txt_record_name = 3; // e.g., "_obiente-verification.example.com"
  string txt_record_value = 4; // e.g., "obiente-verification=abc123..."
  string status = 5; // "pending", "verified", "failed", "expired"
}

message VerifyDomainOwnershipRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string domain = 3;
}

message VerifyDomainOwnershipResponse {
  string domain = 1;
  bool verified = 2;
  string status = 3; // "verified", "failed", "pending"
  optional string message = 4; // Error message if verification failed
}

message GetDeploymentMetricsRequest {
  string deployment_id = 1;
  string organization_id = 2;
  // Optional: time range for historical metrics
  optional google.protobuf.Timestamp start_time = 3;
  optional google.protobuf.Timestamp end_time = 4;
  // If true, return only the latest metrics point
  optional bool latest_only = 5;
  // Optional: filter by container_id (if not specified, returns aggregated metrics across all containers)
  optional string container_id = 6;
  // Optional: filter by service_name (alternative to container_id, matches containers by service name)
  optional string service_name = 7;
  // If true, aggregate metrics across all containers (sum for network/disk, avg for CPU/memory)
  // If false and container_id/service_name not specified, aggregates are returned
  optional bool aggregate = 8;
}

message GetDeploymentMetricsResponse {
  repeated DeploymentMetric metrics = 1;
}

message StreamDeploymentMetricsRequest {
  string deployment_id = 1;
  string organization_id = 2;
  // How often to send updates (in seconds, default: 5)
  optional int32 interval_seconds = 3;
  // Optional: filter by container_id (if not specified, returns aggregated metrics across all containers)
  optional string container_id = 4;
  // Optional: filter by service_name (alternative to container_id, matches containers by service name)
  optional string service_name = 5;
  // If true, aggregate metrics across all containers (sum for network/disk, avg for CPU/memory)
  // If false and container_id/service_name not specified, aggregates are returned
  optional bool aggregate = 6;
}

message DeploymentMetric {
  string deployment_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  // CPU usage as percentage (0-100)
  double cpu_usage_percent = 3;
  // Memory usage in bytes
  int64 memory_usage_bytes = 4;
  // Network receive bytes (total since container start)
  int64 network_rx_bytes = 5;
  // Network transmit bytes (total since container start)
  int64 network_tx_bytes = 6;
  // Disk read bytes (total since container start)
  int64 disk_read_bytes = 7;
  // Disk write bytes (total since container start)
  int64 disk_write_bytes = 8;
  // Request count (if tracked via middleware)
  optional int64 request_count = 9;
  // Error count (if tracked via middleware)
  optional int64 error_count = 10;
  // Container ID this metric is from (for multi-container deployments)
  optional string container_id = 11;
  // Service name this metric is from (for multi-container deployments)
  optional string service_name = 12;
}

message GetDeploymentUsageRequest {
  string deployment_id = 1;
  string organization_id = 2;
  // Optional: specify a month (YYYY-MM format). Defaults to current month.
  optional string month = 3;
}

message GetDeploymentUsageResponse {
  string deployment_id = 1;
  string organization_id = 2;
  string month = 3; // YYYY-MM format
  DeploymentUsageMetrics current = 4;
  DeploymentUsageMetrics estimated_monthly = 5;
}

message DeploymentUsageMetrics {
  int64 cpu_core_seconds = 1;
  int64 memory_byte_seconds = 2;
  int64 bandwidth_rx_bytes = 3;
  int64 bandwidth_tx_bytes = 4;
  int64 storage_bytes = 5;
  int64 request_count = 6;
  int64 error_count = 7;
  int64 uptime_seconds = 8;
  // Estimated cost in cents
  int64 estimated_cost_cents = 9;
  // Per-resource cost breakdown in cents
  optional int64 cpu_cost_cents = 10;
  optional int64 memory_cost_cents = 11;
  optional int64 bandwidth_cost_cents = 12;
  optional int64 storage_cost_cents = 13;
}

message Deployment {
  string id = 1;
  string name = 2;
  string domain = 3;
  repeated string custom_domains = 4;
  DeploymentType type = 5;
  BuildStrategy build_strategy = 26; // build strategy enum
  optional string repository_url = 6;
  string branch = 7;
  optional string build_command = 8;
  optional string install_command = 9;
  optional string start_command = 29; // Start command for running the application
  optional string dockerfile_path = 27; // Path to Dockerfile (relative to repo root, e.g., "Dockerfile", "backend/Dockerfile")
  optional string compose_file_path = 28; // Path to compose file (relative to repo root, e.g., "docker-compose.yml", "compose/production.yml")
  optional string build_path = 34; // Working directory for build (relative to repo root, defaults to ".")
  optional string build_output_path = 35; // Path to built output files (relative to repo root, auto-detected if empty)
  optional bool use_nginx = 36; // Use nginx for static deployments
  optional string nginx_config = 37; // Custom nginx configuration (optional, uses default if empty)
  DeploymentStatus status = 10;
  string health_status = 11;
  google.protobuf.Timestamp last_deployed_at = 12;
  int64 bandwidth_usage = 13;
  int64 storage_usage = 14;
  google.protobuf.Timestamp created_at = 15;
  // Build time in seconds
  int32 build_time = 16;
  // Human-readable bundle size (e.g. "3.4MB")
  string size = 17;
  // Environment enum (production/staging/development)
  Environment environment = 18;
  // Optional groups/labels for organizing deployments
  repeated string groups = 32;
  // Docker/runtime specific view
  optional string image = 19;
  optional int32 port = 20;
  optional int32 replicas = 21;
  repeated string container_ids = 22;
  optional string node_id = 23;
  optional string node_hostname = 24;
  // Environment variables
  map<string, string> env_vars = 25;
  optional string github_integration_id = 33; // GitHub integration ID used for this deployment
  // Container status (for compose deployments)
  optional int32 containers_running = 30; // Number of containers actually running (from Docker)
  optional int32 containers_total = 31; // Total number of containers for this deployment
}

message ListDeploymentContainersRequest {
  string organization_id = 1;
  string deployment_id = 2;
}

message ListDeploymentContainersResponse {
  repeated DeploymentContainer containers = 1;
}

message DeploymentContainer {
  string container_id = 1;
  optional string service_name = 2; // Service name from compose (e.g., "web", "api")
  string status = 3; // running, stopped, exited, etc.
  optional string node_id = 4;
  optional string node_hostname = 5;
  optional int32 port = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

message StreamContainerLogsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string container_id = 3; // Container ID to stream logs from
  int32 tail = 4; // Number of lines to tail (default: 200)
}

message StartContainerRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string container_id = 3; // Container ID to start
}

message StartContainerResponse {
  bool success = 1;
  optional string error = 2;
}

message StopContainerRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string container_id = 3; // Container ID to stop
}

message StopContainerResponse {
  bool success = 1;
  optional string error = 2;
}

message RestartContainerRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string container_id = 3; // Container ID to restart
}

message RestartContainerResponse {
  bool success = 1;
  optional string error = 2;
}

// Build history messages
message ListBuildsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  optional int32 limit = 3; // Maximum number of builds to return (default: 50)
  optional int32 offset = 4; // Offset for pagination
}

message ListBuildsResponse {
  repeated Build builds = 1;
  int32 total = 2; // Total number of builds
}

message GetBuildRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string build_id = 3;
}

message GetBuildResponse {
  Build build = 1;
}

message GetBuildLogsRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string build_id = 3;
  optional int32 limit = 4; // Maximum number of log lines to return (default: all)
  optional int32 offset = 5; // Offset for pagination (for very large logs)
}

message GetBuildLogsResponse {
  repeated DeploymentLogLine logs = 1;
  int32 total = 2; // Total number of log lines
}

message RevertToBuildRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string build_id = 3;
}

message RevertToBuildResponse {
  Deployment deployment = 1; // Updated deployment after revert
  string new_build_id = 2; // ID of the new build created from the revert
}

message DeleteBuildRequest {
  string organization_id = 1;
  string deployment_id = 2;
  string build_id = 3;
}

message DeleteBuildResponse {
  bool success = 1;
}

message Build {
  string id = 1;
  string deployment_id = 2;
  string organization_id = 3;
  int32 build_number = 4; // Sequential build number per deployment
  BuildStatus status = 5;
  google.protobuf.Timestamp started_at = 6;
  optional google.protobuf.Timestamp completed_at = 7;
  int32 build_time = 8; // Duration in seconds
  string triggered_by = 9; // User ID who triggered the build
  
  // Build configuration snapshot (captured at build time)
  optional string repository_url = 10;
  string branch = 11;
  optional string commit_sha = 12; // Git commit SHA if available
  optional string build_command = 13;
  optional string install_command = 14;
  optional string start_command = 15;
  optional string dockerfile_path = 16;
  optional string compose_file_path = 17;
  BuildStrategy build_strategy = 18;
  
  // Build results
  optional string image_name = 19; // Built image name (for single container)
  optional string compose_yaml = 20; // Docker Compose YAML (for compose deployments)
  optional string size = 21; // Human-readable bundle size
  optional string error = 22; // Error message if build failed
  
  google.protobuf.Timestamp created_at = 23;
  google.protobuf.Timestamp updated_at = 24;
}