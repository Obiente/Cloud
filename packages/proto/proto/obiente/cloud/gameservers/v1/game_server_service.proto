syntax = "proto3";

package obiente.cloud.gameservers.v1;

option go_package = "github.com/obiente/cloud/apps/shared/proto/obiente/cloud/gameservers/v1;gameserversv1";

import "google/protobuf/timestamp.proto";
import "obiente/cloud/organizations/v1/organization_service.proto";
import "obiente/cloud/common/v1/common.proto";

// GameType represents the type of game server
enum GameType {
  GAME_TYPE_UNSPECIFIED = 0;
  MINECRAFT = 1;         // Minecraft (Java/Bedrock)
  MINECRAFT_JAVA = 2;    // Minecraft Java Edition
  MINECRAFT_BEDROCK = 3; // Minecraft Bedrock Edition
  VALHEIM = 4;           // Valheim
  TERRARIA = 5;          // Terraria
  RUST = 6;              // Rust
  CS2 = 7;               // Counter-Strike 2
  TF2 = 8;               // Team Fortress 2
  ARK = 9;               // ARK: Survival Evolved
  CONAN = 10;            // Conan Exiles
  SEVEN_DAYS = 11;       // 7 Days to Die
  FACTORIO = 12;         // Factorio
  SPACED_ENGINEERS = 13; // Space Engineers
  OTHER = 99;            // Other/Unknown game
}

// GameServerStatus represents the current status of a game server
enum GameServerStatus {
  GAME_SERVER_STATUS_UNSPECIFIED = 0;
  CREATED = 1;      // Server created but not started
  STARTING = 2;     // Server is starting
  RUNNING = 3;      // Server is running
  STOPPING = 4;     // Server is stopping
  STOPPED = 5;      // Server is stopped
  FAILED = 6;       // Server failed to start or crashed
  RESTARTING = 7;   // Server is restarting
}

service GameServerService {
  // List organization game servers
  rpc ListGameServers(ListGameServersRequest) returns (ListGameServersResponse);
  
  // Create new game server
  rpc CreateGameServer(CreateGameServerRequest) returns (CreateGameServerResponse);
  
  // Get game server details
  rpc GetGameServer(GetGameServerRequest) returns (GetGameServerResponse);
  
  // Update game server configuration
  rpc UpdateGameServer(UpdateGameServerRequest) returns (UpdateGameServerResponse);
  
  // Delete game server
  rpc DeleteGameServer(DeleteGameServerRequest) returns (DeleteGameServerResponse);
  
  // Start a stopped game server
  rpc StartGameServer(StartGameServerRequest) returns (StartGameServerResponse);
  
  // Stop a running game server
  rpc StopGameServer(StopGameServerRequest) returns (StopGameServerResponse);
  
  // Restart a game server
  rpc RestartGameServer(RestartGameServerRequest) returns (RestartGameServerResponse);
  
  // Stream game server status updates
  rpc StreamGameServerStatus(StreamGameServerStatusRequest) returns (stream GameServerStatusUpdate);
  
  // Get game server logs
  rpc GetGameServerLogs(GetGameServerLogsRequest) returns (GetGameServerLogsResponse);

  // Stream game server logs (tail/follow)
  rpc StreamGameServerLogs(StreamGameServerLogsRequest) returns (stream GameServerLogLine);

  // Get game server metrics (real-time or historical)
  rpc GetGameServerMetrics(GetGameServerMetricsRequest) returns (GetGameServerMetricsResponse);

  // Stream real-time game server metrics
  rpc StreamGameServerMetrics(StreamGameServerMetricsRequest) returns (stream GameServerMetric);

  // Get aggregated usage for a game server
  rpc GetGameServerUsage(GetGameServerUsageRequest) returns (GetGameServerUsageResponse);

  // File system operations
  // List files in a game server container or volume
  rpc ListGameServerFiles(ListGameServerFilesRequest) returns (ListGameServerFilesResponse);
  
  // Search for files in a game server container or volume (recursive search)
  rpc SearchGameServerFiles(SearchGameServerFilesRequest) returns (SearchGameServerFilesResponse);
  
  // Get file contents from a game server container or volume
  rpc GetGameServerFile(GetGameServerFileRequest) returns (GetGameServerFileResponse);
  
  // Upload files to a game server container or volume
  rpc UploadGameServerFiles(UploadGameServerFilesRequest) returns (UploadGameServerFilesResponse);
  
  // Chunk-based file upload that streams without buffering large payloads in memory.
  // Clients send a single unary request with file data split into chunks.
  rpc ChunkUploadGameServerFiles(ChunkUploadGameServerFilesRequest) returns (ChunkUploadGameServerFilesResponse);
  
  // Delete files or directories from a game server
  rpc DeleteGameServerEntries(DeleteGameServerEntriesRequest) returns (DeleteGameServerEntriesResponse);
  
  // Create a file, directory, or symlink in a game server
  rpc CreateGameServerEntry(CreateGameServerEntryRequest) returns (CreateGameServerEntryResponse);
  
  // Write or update file contents in a game server
  rpc WriteGameServerFile(WriteGameServerFileRequest) returns (WriteGameServerFileResponse);
  
  // Rename a file or directory in a game server
  rpc RenameGameServerEntry(RenameGameServerEntryRequest) returns (RenameGameServerEntryResponse);
  
  // Extract a zip file to a destination directory
  rpc ExtractGameServerFile(ExtractGameServerFileRequest) returns (ExtractGameServerFileResponse);
  
  // Create a zip archive from files or folders
  rpc CreateGameServerFileArchive(CreateGameServerFileArchiveRequest) returns (CreateGameServerFileArchiveResponse);
  
  // Minecraft player lookup (proxies Mojang API to avoid CORS)
  // Get player UUID from username
  rpc GetMinecraftPlayerUUID(GetMinecraftPlayerUUIDRequest) returns (GetMinecraftPlayerUUIDResponse);
  
  // Get player profile (name, UUID) from UUID
  rpc GetMinecraftPlayerProfile(GetMinecraftPlayerProfileRequest) returns (GetMinecraftPlayerProfileResponse);

  // Minecraft content catalog (Modrinth integration)
  rpc ListMinecraftProjects(ListMinecraftProjectsRequest) returns (ListMinecraftProjectsResponse);

  // Retrieve available versions/files for a specific project
  rpc GetMinecraftProjectVersions(GetMinecraftProjectVersionsRequest) returns (GetMinecraftProjectVersionsResponse);

  rpc GetMinecraftProject(GetMinecraftProjectRequest) returns (GetMinecraftProjectResponse);

  // Download and install a Minecraft mod/plugin directly onto the server
  rpc InstallMinecraftProjectFile(InstallMinecraftProjectFileRequest) returns (InstallMinecraftProjectFileResponse);
}

// Request/Response messages
message ListGameServersRequest {
  string organization_id = 1;
  optional string game_type = 2; // Filter by game type
  optional GameServerStatus status = 3; // Filter by status
}

message ListGameServersResponse {
  repeated GameServer game_servers = 1;
}

message CreateGameServerRequest {
  string organization_id = 1;
  string name = 2;
  GameType game_type = 3;
  
  // Resource configuration
  optional int64 memory_bytes = 4;    // Memory limit in bytes (e.g., 2147483648 for 2GB)
  optional int32 cpu_cores = 5;       // CPU cores (e.g., 2 for 2 cores)
  optional int32 port = 6;            // Game server port (auto-assigned if not specified)
  
  // Docker image configuration
  optional string docker_image = 7;   // Custom Docker image (uses default for game type if not specified)
  optional string start_command = 8;   // Custom start command (uses default for game type if not specified)
  
  // Environment variables
  map<string, string> env_vars = 9;
  
  // Additional configuration
  optional string server_version = 10; // Game server version (e.g., "1.20.1" for Minecraft)
  optional string description = 11;    // Optional description
}

message CreateGameServerResponse {
  GameServer game_server = 1;
}

message GetGameServerRequest {
  string game_server_id = 1;
}

message GetGameServerResponse {
  GameServer game_server = 1;
}

message UpdateGameServerRequest {
  string game_server_id = 1;
  
  optional string name = 2;
  optional int64 memory_bytes = 3;
  optional int32 cpu_cores = 4;
  map<string, string> env_vars = 5;  // Maps are optional by default in proto3
  optional string start_command = 6;
  optional string description = 7;
  optional string server_version = 8; // Game server version (e.g., "1.20.1" for Minecraft)
}

message UpdateGameServerResponse {
  GameServer game_server = 1;
}

message DeleteGameServerRequest {
  string game_server_id = 1;
}

message DeleteGameServerResponse {
  bool success = 1;
}

message StartGameServerRequest {
  string game_server_id = 1;
}

message StartGameServerResponse {
  GameServer game_server = 1;
}

message StopGameServerRequest {
  string game_server_id = 1;
}

message StopGameServerResponse {
  GameServer game_server = 1;
}

message RestartGameServerRequest {
  string game_server_id = 1;
}

message RestartGameServerResponse {
  GameServer game_server = 1;
}

message StreamGameServerStatusRequest {
  string game_server_id = 1;
}

message GameServerStatusUpdate {
  string game_server_id = 1;
  GameServerStatus status = 2;
  optional string message = 3;
  google.protobuf.Timestamp timestamp = 4;
}

message GetGameServerLogsRequest {
  string game_server_id = 1;
  optional int32 limit = 2;          // Max number of lines to return
  optional google.protobuf.Timestamp since = 3; // Get logs since this timestamp (for pagination)
  optional google.protobuf.Timestamp until = 4; // Get logs until this timestamp (for historical loading)
  optional string search_query = 5;   // Search query to filter logs (case-insensitive substring match)
}

message GetGameServerLogsResponse {
  repeated GameServerLogLine lines = 1;
}

message StreamGameServerLogsRequest {
  string game_server_id = 1;
  optional bool follow = 2;         // Follow logs (like tail -f, default: true)
  optional int32 tail = 3;          // Number of lines to tail (default: 100)
  optional google.protobuf.Timestamp since = 4; // Get historical logs since this timestamp
  optional google.protobuf.Timestamp until = 5; // Get historical logs until this timestamp (for pagination)
  optional string search_query = 6;   // Search query to filter logs (case-insensitive substring match)
}

message GameServerLogLine {
  string line = 1;
  google.protobuf.Timestamp timestamp = 2;
  optional obiente.cloud.common.v1.LogLevel level = 3;
}

message GetGameServerMetricsRequest {
  string game_server_id = 1;
  optional google.protobuf.Timestamp start_time = 2;
  optional google.protobuf.Timestamp end_time = 3;
  optional string aggregation = 4;  // "1m", "5m", "1h", etc.
}

message GetGameServerMetricsResponse {
  repeated GameServerMetric metrics = 1;
}

message StreamGameServerMetricsRequest {
  string game_server_id = 1;
}

message GameServerMetric {
  string game_server_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  optional double cpu_usage_percent = 3;        // CPU usage percentage (0-100)
  optional int64 memory_usage_bytes = 4;       // Current memory usage in bytes
  optional int64 memory_limit_bytes = 5;       // Memory limit in bytes
  optional int64 network_rx_bytes = 6;          // Network received bytes
  optional int64 network_tx_bytes = 7;          // Network transmitted bytes
  optional int64 disk_read_bytes = 10;          // Disk read bytes
  optional int64 disk_write_bytes = 11;         // Disk write bytes
  optional int32 player_count = 8;              // Current player count (if available)
  optional int32 max_players = 9;               // Max player count (if available)
}

message GetGameServerUsageRequest {
  string game_server_id = 1;
  string organization_id = 2;
  // Optional: specify a month (YYYY-MM format). Defaults to current month.
  optional string month = 3;
}

message GetGameServerUsageResponse {
  string game_server_id = 1;
  string organization_id = 2;
  string month = 3; // YYYY-MM format
  GameServerUsageMetrics current = 4;
  GameServerUsageMetrics estimated_monthly = 5;
}

message GameServerUsageMetrics {
  int64 cpu_core_seconds = 1;
  int64 memory_byte_seconds = 2;
  int64 bandwidth_rx_bytes = 3;
  int64 bandwidth_tx_bytes = 4;
  int64 storage_bytes = 5;
  int64 uptime_seconds = 6;
  // Estimated cost in cents
  int64 estimated_cost_cents = 7;
  // Per-resource cost breakdown in cents
  optional int64 cpu_cost_cents = 8;
  optional int64 memory_cost_cents = 9;
  optional int64 bandwidth_cost_cents = 10;
  optional int64 storage_cost_cents = 11;
}

// GameServer represents a game server instance
message GameServer {
  string id = 1;
  string organization_id = 2;
  string name = 3;
  optional string description = 4;
  GameType game_type = 5;
  GameServerStatus status = 6;
  
  // Resource configuration
  int64 memory_bytes = 7;
  int32 cpu_cores = 8;
  int32 port = 9;
  
  // Docker configuration
  string docker_image = 10;
  optional string start_command = 11;
  
  // Environment variables
  map<string, string> env_vars = 12;
  
  // Game-specific configuration
  optional string server_version = 13;
  
  // Resource usage (if available)
  optional int32 player_count = 14;
  optional int32 max_players = 15;
  
  // Timestamps
  google.protobuf.Timestamp created_at = 16;
  google.protobuf.Timestamp updated_at = 17;
  optional google.protobuf.Timestamp last_started_at = 18;
  
  // Container information
  optional string container_id = 19;
  optional string container_name = 20;
  
  // Storage
  int64 storage_bytes = 21;
  
  // Created by
  string created_by = 22;
}

// File system messages (similar to deployments)
message GameServerFile {
  string name = 1;
  string path = 2;
  bool is_directory = 3;
  int64 size = 4;
  string permissions = 5;
  optional string volume_name = 6; // If this file is in a volume, the volume name
  optional string owner = 7;
  optional string group = 8;
  optional uint32 mode_octal = 9;
  optional bool is_symlink = 10;
  optional string symlink_target = 11;
  optional string mime_type = 12;
  optional google.protobuf.Timestamp modified_time = 13;
  optional google.protobuf.Timestamp created_time = 14;
}

message GameServerVolumeInfo {
  string name = 1; // Volume name
  string mount_point = 2; // Mount point inside container (e.g., "/data")
  string source = 3; // Volume source path on host
  bool is_persistent = 4; // Whether this is a persistent volume
}

message ListGameServerFilesRequest {
  string game_server_id = 1;
  string path = 2; // Directory path (default: "/")
  optional string volume_name = 3; // If specified, list files from this volume instead of container filesystem
  optional string cursor = 4; // Pagination cursor
  optional int32 page_size = 5; // Number of files per page
  optional bool list_volumes = 6; // If true, only return available volumes
}

message ListGameServerFilesResponse {
  repeated GameServerFile files = 1;
  string current_path = 2;
  repeated GameServerVolumeInfo volumes = 3; // Available persistent volumes (only when list_volumes=true)
  bool is_volume = 4; // Whether the current listing is from a volume
  bool container_running = 5; // Whether the container is currently running
  bool has_more = 6;
  optional string next_cursor = 7;
}

message SearchGameServerFilesRequest {
  string game_server_id = 1;
  string query = 2; // Search query (searches in file and directory names, case-insensitive)
  optional string root_path = 3; // Root path to search from (default: "/")
  optional string volume_name = 4; // If specified, search in this volume instead of container filesystem
  optional int32 max_results = 5; // Maximum number of results to return (default: 100)
  optional bool files_only = 6; // If true, only return files (exclude directories)
  optional bool directories_only = 7; // If true, only return directories (exclude files)
}

message SearchGameServerFilesResponse {
  repeated GameServerFile results = 1; // Matching files and directories
  int32 total_found = 2; // Total number of matches found
  bool has_more = 3; // Whether there are more results beyond max_results
  bool container_running = 4; // Whether the container is currently running
}

message GetGameServerFileRequest {
  string game_server_id = 1;
  string path = 2; // File path
  optional string volume_name = 3; // If specified, read file from this volume instead of container filesystem
}

message GetGameServerFileResponse {
  string content = 1;
  string encoding = 2; // "text" or "base64"
  int64 size = 3;
  optional bool truncated = 4;
  optional GameServerFile metadata = 5;
}

message UploadGameServerFilesRequest {
  UploadGameServerFilesMetadata metadata = 1; // Metadata about the upload
  bytes tar_data = 2; // Complete tar archive containing all files
}

message UploadGameServerFilesMetadata {
  string game_server_id = 1;
  string destination_path = 2; // Directory path where files should be extracted (default: "/")
  repeated GameServerFileMetadata files = 3; // Metadata about files being uploaded
  optional string volume_name = 4; // If specified, upload files to this volume instead of container filesystem
}

message GameServerFileMetadata {
  string name = 1; // File name
  int64 size = 2; // File size in bytes
  bool is_directory = 3; // Whether this is a directory
  string path = 4; // Relative path within the archive
}

message UploadGameServerFilesResponse {
  bool success = 1;
  optional string error = 2;
  int32 files_uploaded = 3; // Number of files successfully uploaded
}

// ChunkUploadGameServerFilesRequest contains a single file chunk with metadata.
// Clients should split each file into chunks (e.g., 64KB each) and send multiple unary requests.
// The server assembles chunks into a complete file stream and uploads to the target destination without buffering.
message ChunkUploadGameServerFilesRequest {
  string game_server_id = 1;
  string destination_path = 2; // Directory path where files should be extracted (default: "/")
  optional string volume_name = 3; // If specified, upload to this volume
  string file_name = 4; // Name of the file being uploaded
  int64 file_size = 5; // Total size of the complete file (for validation)
  int32 chunk_index = 6; // 0-based index of this chunk
  int32 total_chunks = 7; // Total number of chunks for this file
  bytes chunk_data = 8; // Raw file data for this chunk
  optional string file_mode = 9; // File permissions (e.g., "0644"), optional
}

message ChunkUploadGameServerFilesResponse {
  bool success = 1;
  optional string error = 2;
  string file_name = 3; // Name of the uploaded file
  int64 bytes_received = 4; // Total bytes received for this file so far
}


enum GameServerEntryType {
  GAME_SERVER_ENTRY_TYPE_UNSPECIFIED = 0;
  GAME_SERVER_ENTRY_TYPE_FILE = 1;
  GAME_SERVER_ENTRY_TYPE_DIRECTORY = 2;
  GAME_SERVER_ENTRY_TYPE_SYMLINK = 3;
}

message DeleteGameServerEntriesRequest {
  string game_server_id = 1;
  repeated string paths = 2;
  optional string volume_name = 3;
  bool recursive = 4;
  bool force = 5;
}

message DeleteGameServerEntriesError {
  string path = 1;
  string message = 2;
}

message DeleteGameServerEntriesResponse {
  bool success = 1;
  repeated string deleted_paths = 2;
  repeated DeleteGameServerEntriesError errors = 3;
}

message RenameGameServerEntryRequest {
  string game_server_id = 1;
  string source_path = 2;
  string target_path = 3;
  optional string volume_name = 4;
  bool overwrite = 5;
}

message RenameGameServerEntryResponse {
  bool success = 1;
  optional GameServerFile entry = 2;
}

message CreateGameServerEntryRequest {
  string game_server_id = 1;
  string parent_path = 2;
  string name = 3;
  GameServerEntryType type = 4;
  optional string template = 5; // Optional template identifier for seeded content (required for symlinks - target path)
  optional string volume_name = 6;
  optional uint32 mode_octal = 7;
}

message CreateGameServerEntryResponse {
  GameServerFile entry = 1;
}

message WriteGameServerFileRequest {
  string game_server_id = 1;
  string path = 2;
  optional string volume_name = 3;
  string content = 4;
  string encoding = 5; // "text" or "base64"
  bool create_if_missing = 6;
  optional uint32 mode_octal = 7;
}

message WriteGameServerFileResponse {
  bool success = 1;
  optional GameServerFile entry = 2;
  optional string error = 3;
}

message ExtractGameServerFileRequest {
  string game_server_id = 1;
  string zip_path = 2; // Path to the zip file to extract (from common.ExtractServerFileRequest)
  string destination_path = 3; // Directory path where files should be extracted (from common.ExtractServerFileRequest)
  optional string volume_name = 4; // If specified, extract to this volume instead of container filesystem (from common.ExtractServerFileRequest)
}

message ExtractGameServerFileResponse {
  bool success = 1; // From common.ExtractServerFileResponse
  optional string error = 2; // From common.ExtractServerFileResponse
  int32 files_extracted = 3; // Number of files successfully extracted (from common.ExtractServerFileResponse)
}

message CreateGameServerFileArchiveRequest {
  string game_server_id = 1;
  obiente.cloud.common.v1.CreateServerFileArchiveRequest archive_request = 2; // Shared archive request
  optional string volume_name = 3; // If specified, create archive in this volume instead of container filesystem
}

message CreateGameServerFileArchiveResponse {
  obiente.cloud.common.v1.CreateServerFileArchiveResponse archive_response = 1; // Shared archive response
}

// Minecraft player lookup messages
message GetMinecraftPlayerUUIDRequest {
  string username = 1; // Minecraft username
}

message GetMinecraftPlayerUUIDResponse {
  optional string uuid = 1; // Player UUID (dashed format, e.g., "550e8400-e29b-41d4-a716-446655440000")
  optional string name = 2; // Current username (may differ from requested username if changed)
}

message GetMinecraftPlayerProfileRequest {
  string uuid = 1; // Player UUID (dashed or undashed format)
}

message GetMinecraftPlayerProfileResponse {
  optional string uuid = 1; // Player UUID (dashed format)
  optional string name = 2; // Current username
  optional string avatar_url = 3; // Avatar URL (from Crafatar)
}

// Minecraft catalog messages
enum MinecraftProjectType {
  MINECRAFT_PROJECT_TYPE_UNSPECIFIED = 0;
  MINECRAFT_PROJECT_TYPE_MOD = 1;
  MINECRAFT_PROJECT_TYPE_PLUGIN = 2;
}

message MinecraftProject {
  string id = 1;
  string slug = 2;
  string title = 3;
  string description = 4;
  MinecraftProjectType project_type = 5;
  string icon_url = 6;
  repeated string categories = 7;
  repeated string loaders = 8;
  repeated string game_versions = 9;
  repeated string authors = 10;
  int64 downloads = 11;
  double rating = 12;
  optional string latest_version_id = 13;
  optional string project_url = 14;
  optional string source_url = 15;
  optional string issues_url = 16;
  optional string body = 17; // Full body/description with markdown
  repeated string gallery = 18; // Screenshot/image URLs
}

message ListMinecraftProjectsRequest {
  string game_server_id = 1;
  optional string query = 2;
  repeated string game_versions = 3;
  repeated string loaders = 4;
  repeated string categories = 5;
  optional string cursor = 6;
  optional int32 limit = 7;
  MinecraftProjectType project_type = 8;
}

message ListMinecraftProjectsResponse {
  repeated MinecraftProject projects = 1;
  bool has_more = 2;
  optional string next_cursor = 3;
}

message MinecraftProjectFile {
  string filename = 1;
  string url = 2;
  int64 size_bytes = 3;
  map<string, string> hashes = 4;
  bool primary = 5;
}

message MinecraftProjectVersion {
  string id = 1;
  string name = 2;
  string version_number = 3;
  repeated string game_versions = 4;
  repeated string loaders = 5;
  bool server_side_supported = 6;
  bool client_side_supported = 7;
  optional google.protobuf.Timestamp published_at = 8;
  optional string changelog = 9;
  repeated MinecraftProjectFile files = 10;
}

message GetMinecraftProjectVersionsRequest {
  string game_server_id = 1;
  string project_id = 2;
  repeated string game_versions = 3;
  repeated string loaders = 4;
  MinecraftProjectType project_type = 5;
  optional int32 limit = 6;
}

message GetMinecraftProjectVersionsResponse {
  repeated MinecraftProjectVersion versions = 1;
}

message GetMinecraftProjectRequest {
  string game_server_id = 1;
  string project_id = 2;
}

message GetMinecraftProjectResponse {
  MinecraftProject project = 1;
}

message InstallMinecraftProjectFileRequest {
  string game_server_id = 1;
  string project_id = 2;
  string version_id = 3;
  MinecraftProjectType project_type = 4;
}

message InstallMinecraftProjectFileResponse {
  bool success = 1;
  string filename = 2;
  string installed_path = 3;
  bool restart_required = 4;
  optional string message = 5;
}

